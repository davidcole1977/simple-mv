'use strict';function unsubscribe(subscription){subscription.unsubscribe()}function isDelegatedListener(options){return'boolean'==typeof options.delegate&&options.delegate===!0&&'string'==typeof options.keypath}function delegatedCallback(delegatedKeypath,callback,event){sh.keypathIsSameOrDescendent(delegatedKeypath,event.keypath)&&callback(event)}var sh=require('./simple-helpers'),_=require('lodash'),appSubsList=require('./app-subscriptions');module.exports={getTopicName:function(options,isDelegated){var topic;return'undefined'==typeof options.target&&(options.target=this),topic=options.eventType+':'+options.target.id,'string'!=typeof options.keypath||isDelegated||(topic+=':'+options.keypath),topic},getAllTopicNames:function(options){var publishTopics;return'undefined'==typeof options.target&&(options.target=this),publishTopics=[options.eventType,options.eventType+':'+options.target.id],'string'==typeof options.keypath&&publishTopics.push(options.eventType+':'+options.target.id+':'+options.keypath),publishTopics},getDelegatedCallback:function(keypath,callback){return delegatedCallback.bind(this,keypath,callback)},createLocalSubsListTopic:function(options){'undefined'==typeof this.subscriptions[options.subsScope][options.topic]&&(this.subscriptions[options.subsScope][options.topic]={unNameSpaced:[]}),'string'==typeof options.nameSpace&&'undefined'==typeof this.subscriptions[options.subsScope][options.topic][options.nameSpace]&&(this.subscriptions[options.subsScope][options.topic][options.nameSpace]=[])},getLocalSubsListTopic:function(options){var nameSpace='string'==typeof options.nameSpace?options.nameSpace:'unNameSpaced';return this.subscriptions[options.subsScope][options.topic][nameSpace]},assignSubscription:function(options,callback){var newSubscription=appSubsList.createSubscription(options.topic,callback);this.createLocalSubsListTopic(options),this.getLocalSubsListTopic(options).push(newSubscription)},addListener:function(options,subsScope,callback){var subsOptions,isDelegated=isDelegatedListener(options);callback=isDelegated?this.getDelegatedCallback(options.keypath,callback):callback,subsOptions={topic:this.getTopicName(options,isDelegated),nameSpace:options.nameSpace,subsScope:subsScope},this.assignSubscription(subsOptions,callback)},removeListener:function(options,subsScope){var subsArray,topic=this.getTopicName(options);'undefined'==typeof options.nameSpace?(subsArray=this.subscriptions[subsScope][topic].unNameSpaced,subsArray.forEach(unsubscribe),subsArray.splice(0,subsArray.length)):(this.subscriptions[subsScope][topic][options.nameSpace].forEach(unsubscribe),delete this.subscriptions[subsScope][topic][options.nameSpace])},emitEvent:function(eventType,keypath){var publishParams={target:this,eventType:eventType},topicNameOptions={eventType:eventType};'string'==typeof keypath&&(topicNameOptions.keypath=keypath,publishParams.keypath=keypath),this.getAllTopicNames(topicNameOptions).forEach(function(topic){appSubsList.publish(topic,publishParams)})},on:function(options,callback){this.addListener(options,'internal',callback)},off:function(options){this.removeListener(options,'internal')},listenTo:function(options,callback){this.addListener(options,'external',callback)},stopListeningTo:function(options){this.removeListener(options,'external')}};