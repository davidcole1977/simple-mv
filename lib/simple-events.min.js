'use strict';function unsubscribe(subscription){subscription.unsubscribe()}function isDelegatedListener(keypath,delegate){return'boolean'==typeof delegate&&delegate===!0&&'string'==typeof keypath}function delegatedCallback(delegatedKeypath,callback,event){sh.keypathIsSameOrDescendent(delegatedKeypath,event.keypath)&&callback(event)}var sh=require('./simple-helpers'),_=require('lodash'),appSubsList=require('./app-subscriptions');module.exports={getListenerTopicName:function(options,isDelegated){var topic=options.eventType+':'+options.target.id;return'string'!=typeof options.keypath||isDelegated||(topic+=':'+options.keypath),topic},getEmissionTopicNames:function(options){var publishTopics=[options.eventType,options.eventType+':'+this.id];return'string'==typeof options.keypath&&publishTopics.push(options.eventType+':'+this.id+':'+options.keypath),publishTopics},delegateCallback:function(keypath,callback){return delegatedCallback.bind(this,keypath,callback)},createLocalSubsListTopic:function(topic,subsScope,nameSpace){return nameSpace='string'==typeof nameSpace?nameSpace:'unNameSpaced','undefined'==typeof this.subscriptions[subsScope][topic]&&(this.subscriptions[subsScope][topic]={}),'undefined'==typeof this.subscriptions[subsScope][topic][nameSpace]&&(this.subscriptions[subsScope][topic][nameSpace]=[]),this.subscriptions[subsScope][topic][nameSpace]},addListener:function(options,subsScope,callback){var newSubscription,isDelegated=isDelegatedListener(options.keypath,options.delegate),topic=this.getListenerTopicName(options,isDelegated);callback=isDelegated?this.delegateCallback(options.keypath,callback):callback,newSubscription=appSubsList.createSubscription(topic,callback),this.createLocalSubsListTopic(topic,subsScope,options.nameSpace).push(newSubscription)},removeListener:function(options,subsScope){var nameSpace='undefined'==typeof options.nameSpace?'unNameSpaced':options.nameSpace,topic=this.getListenerTopicName(options),subsArray=this.subscriptions[subsScope][topic][nameSpace];subsArray.forEach(unsubscribe),'unNameSpaced'===nameSpace?subsArray.splice(0,subsArray.length):delete this.subscriptions[subsScope][topic][nameSpace]},emitEvent:function(eventType,keypath){var publishParams={target:this,eventType:eventType},topicNameOptions={eventType:eventType};'string'==typeof keypath&&(topicNameOptions.keypath=keypath,publishParams.keypath=keypath),this.getEmissionTopicNames(topicNameOptions).forEach(function(topic){appSubsList.publish(topic,publishParams)})},on:function(options,callback){options.target=this,this.addListener(options,'internal',callback)},off:function(options){options.target=this,this.removeListener(options,'internal')},listenTo:function(options,callback){this.addListener(options,'external',callback)},stopListeningTo:function(options){this.removeListener(options,'external')}};